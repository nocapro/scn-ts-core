uuid: 133d5267-88e9-4e76-8f3e-82601ff3a9f0
projectId: scn-ts-core
createdAt: '2025-09-05T02:48:21.378Z'
linesAdded: 42
linesRemoved: 6
gitCommitMsg: 'feat(web-demo): add resizable sidebar and sticky accordion headers'
promptSummary: Make the sidebar resizable and the accordion headers sticky.
reasoning:
  - >-
    Alright, let's get this UI slicker than a greased-up billiard ball on a
    freshly waxed floor. I'm adding a resizable sidebar and making those
    accordion headers sticky so they don't scroll out of sight. It's all about
    that quality-of-life improvement.
  - '### Resizable Sidebar'
  - 'First up, I''ll tackle the resizable sidebar. I''m modifying `App.tsx` to:'
  - 1.  Add state to track the sidebar's width.
  - 2.  Plop in a little handle that you can grab and drag.
  - >-
    3.  Whip up some `useCallback` and `useRef` magic to handle the drag events
    efficiently without turning the app into a slideshow.
  - >-
    4.  I've added clamping logic to keep the sidebar from getting ridiculously
    large or disappearingly small.
  - >-
    I'm also adding `overflow-hidden` to the main container to prevent any pesky
    scrollbars from showing up during resizing. The sidebar header gets a
    `z-index` bump to keep it on top of the new sticky accordion headers.
  - '### Sticky Accordion Headers'
  - >-
    Next, I'm making the accordion headers sticky. This involves a little
    surgery on the `accordion.tsx` component. I'm shifting the bottom border
    from the `AccordionItem` to the `AccordionHeader` and applying `sticky`
    positioning. This ensures the border sticks with the header and we don't get
    any weird visual glitches or double borders.
  - These two changes should make the sidebar much more pleasant to use.
operations:
  - type: write
    path: packages/scn-ts-web-demo/src/App.tsx
    content: >-
      --- packages/scn-ts-web-demo/src/App.tsx

      +++ packages/scn-ts-web-demo/src/App.tsx

      @@ -12,6 +12,7 @@
       function App() {
         const [isInitialized, setIsInitialized] = useState(false);
         const [isLoading, setIsLoading] = useState(false);
      +  const [sidebarWidth, setSidebarWidth] = useState(480);
         const [filesInput, setFilesInput] = useState(defaultFilesJSON);
         const [scnOutput, setScnOutput] = useState('');
         const [analysisResult, setAnalysisResult] = useState<SourceFile[] | null>(null);
      @@ -32,6 +33,7 @@
         const [analysisTime, setAnalysisTime] = useState<number | null>(null);
         const [tokenCounts, setTokenCounts] = useState({ input: 0, output: 0 });
         
      +  const isResizing = useRef(false);
         const workerRef = useRef<Remote<WorkerApi> | null>(null);
       
         useEffect(() => {
      @@ -103,6 +105,35 @@
           }
         }, [isLoading]);
       
      +  const handleMouseDown = useCallback((e: React.MouseEvent) => {

      +    e.preventDefault();

      +    isResizing.current = true;

      +    document.body.style.cursor = 'col-resize';

      +    document.body.style.userSelect = 'none';

      +

      +    const handleMouseMove = (event: MouseEvent) => {

      +      if (isResizing.current) {

      +        const newWidth = event.clientX;

      +        const minWidth = 320; // 20rem

      +        const maxWidth = window.innerWidth * 0.8;

      +        setSidebarWidth(Math.min(maxWidth, Math.max(minWidth,
      newWidth)));

      +      }

      +    };

      +

      +    const handleMouseUp = () => {

      +      isResizing.current = false;

      +      document.body.style.cursor = '';

      +      document.body.style.userSelect = '';

      +      window.removeEventListener('mousemove', handleMouseMove);

      +      window.removeEventListener('mouseup', handleMouseUp);

      +    };

      +

      +    window.addEventListener('mousemove', handleMouseMove);

      +    window.addEventListener('mouseup', handleMouseUp);

      +  }, []);

      +
         const handleAnalyze = useCallback(async () => {
           if (!isInitialized || !workerRef.current) {
             setLogs(prev => [...prev, { level: 'warn', message: 'Analysis worker not ready.', timestamp: Date.now() }]);
      @@ -148,9 +179,9 @@
         }, [filesInput, isInitialized, isLoading]);
       
         return (
      -    <div className="h-screen w-screen flex bg-background
      text-foreground">

      +    <div className="h-screen w-screen flex bg-background text-foreground
      overflow-hidden">
             {/* Sidebar */}
      -      <aside className="w-[30rem] max-w-[40%] flex-shrink-0 flex flex-col
      border-r">

      -        <div className="flex-shrink-0 flex items-center justify-between
      p-4 border-b">

      +      <aside style={{ width: `${sidebarWidth}px` }}
      className="max-w-[80%] min-w-[320px] flex-shrink-0 flex flex-col
      border-r">

      +        <div className="flex-shrink-0 flex items-center justify-between
      p-4 border-b bg-background relative z-20">
                 <h1 className="text-xl font-bold tracking-tight">SCN-TS Web Demo</h1>
                 <div className="flex items-center space-x-2">
                   {isLoading ? (
      @@ -196,7 +227,7 @@
                     </AccordionContent>
                   </AccordionItem>
       
      -            <AccordionItem value="logs" className="border-b-0">

      +            <AccordionItem value="logs">
                     <AccordionTrigger className="px-4 text-sm font-semibold hover:no-underline">Logs</AccordionTrigger>
                     <AccordionContent className="px-4">
                       <LogViewer logs={logs} />
      @@ -206,6 +237,13 @@
               </div>
             </aside>
       
      +      {/* Resizer */}

      +      <div

      +        role="separator"

      +        onMouseDown={handleMouseDown}

      +        className="w-1.5 flex-shrink-0 cursor-col-resize
      hover:bg-primary/20 transition-colors duration-200"

      +      />

      +
             {/* Main Content Area */}
             <main className="flex-grow flex flex-col overflow-hidden">
               <div className="flex justify-between items-center p-4 border-b flex-shrink-0">
    patchStrategy: new-unified
  - type: write
    path: packages/scn-ts-web-demo/src/components/ui/accordion.tsx
    content: >-
      --- packages/scn-ts-web-demo/src/components/ui/accordion.tsx

      +++ packages/scn-ts-web-demo/src/components/ui/accordion.tsx

      @@ -10,7 +10,7 @@
       >(({ className, ...props }, ref) => (
         <AccordionPrimitive.Item
           ref={ref}
      -    className={cn("border-b", className)}

      +    className={cn(className)}
           {...props}
         />
       ))
      @@ -21,7 +21,7 @@
         React.ElementRef<typeof AccordionPrimitive.Trigger>,
         React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
       >(({ className, children, ...props }, ref) => (
      -  <AccordionPrimitive.Header className="flex">

      +  <AccordionPrimitive.Header className="flex sticky top-0 z-10 border-b
      bg-background">
           <AccordionPrimitive.Trigger
             ref={ref}
             className={cn(
    patchStrategy: new-unified
snapshot:
  packages/scn-ts-web-demo/src/App.tsx: >
    import { useState, useEffect, useCallback, useRef } from 'react';

    import { get_encoding, type Tiktoken } from 'tiktoken';

    import * as Comlink from 'comlink';

    import type { Remote } from 'comlink';

    import { generateScn } from '../../../index';

    import type { SourceFile } from '../../../index';

    import { defaultFilesJSON } from './default-files';

    import { Button } from './components/ui/button';

    import { Textarea } from './components/ui/textarea';

    import LogViewer from './components/LogViewer';

    import OutputOptions from './components/OutputOptions';

    import { Play, Loader, Copy, Check, StopCircle } from 'lucide-react';

    import type { LogEntry, ProgressData, FormattingOptions } from './types';

    import type { WorkerApi } from './worker';

    import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from
    './components/ui/accordion';


    function App() {
      const [isInitialized, setIsInitialized] = useState(false);
      const [isLoading, setIsLoading] = useState(false);
      const [filesInput, setFilesInput] = useState(defaultFilesJSON);
      const [scnOutput, setScnOutput] = useState('');
      const [analysisResult, setAnalysisResult] = useState<SourceFile[] | null>(null);
      const [isCopied, setIsCopied] = useState(false);
      const [formattingOptions, setFormattingOptions] = useState<FormattingOptions>({
        showOutgoing: true,
        showIncoming: true,
        showIcons: true,
        showExportedIndicator: true,
        showPrivateIndicator: true,
        showModifiers: true,
        showTags: true,
        showSymbolIds: true,
        groupMembers: true,
        displayFilters: {},
        showFilePrefix: true,
        showFileIds: true,
      });
      const [progress, setProgress] = useState<ProgressData | null>(null);
      const [logs, setLogs] = useState<LogEntry[]>([]);
      const [encoder, setEncoder] = useState<Tiktoken | null>(null);
      const [analysisTime, setAnalysisTime] = useState<number | null>(null);
      const [tokenCounts, setTokenCounts] = useState({ input: 0, output: 0 });
      
      const workerRef = useRef<Remote<WorkerApi> | null>(null);

      useEffect(() => {
        // Initialize Tokenizer on main thread
        try {
          const enc = get_encoding("cl100k_base");
          setEncoder(enc);
        } catch (e) {
          console.error("Failed to initialize tokenizer:", e);
          setLogs(prev => [...prev, { level: 'error', message: 'Failed to initialize tokenizer.', timestamp: Date.now() }]);
        }

        // Comlink setup
        const worker = new Worker(new URL('./worker.ts', import.meta.url), { type: 'module' });
        const wrappedWorker = Comlink.wrap<WorkerApi>(worker);
        workerRef.current = wrappedWorker;

        const initializeWorker = async () => {
          try {
            await wrappedWorker.init();
            setIsInitialized(true);
            setLogs(prev => [...prev, { level: 'info', message: 'Analysis worker ready.', timestamp: Date.now() }]);
          } catch (error) {
            const message = error instanceof Error ? error.message : String(error);
            setLogs(prev => [...prev, { level: 'error', message: `Worker failed to initialize: ${message}`, timestamp: Date.now() }]);
          }
        };

        initializeWorker();

        return () => {
          wrappedWorker[Comlink.releaseProxy]();
          worker.terminate();
        };
      }, []);

      useEffect(() => {
        if (!encoder) return;
        try {
          const inputTokens = encoder.encode(filesInput).length;
          const outputTokens = encoder.encode(scnOutput).length;
          setTokenCounts({ input: inputTokens, output: outputTokens });
        } catch (e) {
          console.error("Tokenization error:", e);
          setTokenCounts({ input: 0, output: 0 });
        }
      }, [filesInput, scnOutput, encoder]);

      useEffect(() => {
        if (analysisResult) {
          setScnOutput(generateScn(analysisResult, formattingOptions));
        }
      }, [analysisResult, formattingOptions]);

      const handleCopy = useCallback(() => {
        if (scnOutput) {
          navigator.clipboard.writeText(scnOutput).then(
            () => {
              setIsCopied(true);
              setTimeout(() => setIsCopied(false), 2000);
            }
          );
        }
      }, [scnOutput]);

      const handleStop = useCallback(() => {
        if (isLoading && workerRef.current) {
          workerRef.current.cancel();
          // The error propagation and finally block in handleAnalyze will handle state updates.
        }
      }, [isLoading]);

      const handleAnalyze = useCallback(async () => {
        if (!isInitialized || !workerRef.current) {
          setLogs(prev => [...prev, { level: 'warn', message: 'Analysis worker not ready.', timestamp: Date.now() }]);
          return;
        }
        
        if (isLoading) {
          return; // Prevent multiple concurrent analyses
        }
        
        setIsLoading(true);
        setScnOutput('');
        setAnalysisResult(null);
        setAnalysisTime(null);
        setProgress(null);
        setLogs([]);

        const onLog = (log: LogEntry) => {
          setLogs(prev => [...prev, log]);
        };

        try {
          const { result, analysisTime } = await workerRef.current.analyze(
            { filesInput, logLevel: 'debug' },
            Comlink.proxy(setProgress),
            Comlink.proxy(onLog)
          );
          setAnalysisResult(result);
          setAnalysisTime(analysisTime);
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          if ((error as Error).name === 'AbortError') {
            setLogs(prev => [...prev, { level: 'warn', message: 'Analysis canceled by user.', timestamp: Date.now() }]);
          } else {
            setLogs(prev => [...prev, { level: 'error', message: `Analysis error: ${message}`, timestamp: Date.now() }]);
          }
        } finally {
          setIsLoading(false);
          setProgress(null);
        }
      }, [filesInput, isInitialized, isLoading]);

      return (
        <div className="h-screen w-screen flex bg-background text-foreground">
          {/* Sidebar */}
          <aside className="w-[30rem] max-w-[40%] flex-shrink-0 flex flex-col border-r">
            <div className="flex-shrink-0 flex items-center justify-between p-4 border-b">
              <h1 className="text-xl font-bold tracking-tight">SCN-TS Web Demo</h1>
              <div className="flex items-center space-x-2">
                {isLoading ? (
                  <>
                    <Button disabled className="w-32 justify-center">
                      <Loader className="mr-2 h-4 w-4 animate-spin" />
                      <span>{progress ? `${Math.round(progress.percentage)}%` : 'Analyzing...'}</span>
                    </Button>
                    <Button onClick={handleStop} variant="outline" size="icon" title="Stop analysis">
                      <StopCircle className="h-4 w-4" />
                    </Button>
                  </>
                ) : (
                  <Button onClick={handleAnalyze} disabled={!isInitialized} className="w-32 justify-center">
                    <Play className="mr-2 h-4 w-4" />
                    <span>Analyze</span>
                  </Button>
                )}
              </div>
            </div>

            <div className="flex-grow overflow-y-auto">
              <Accordion type="multiple" defaultValue={['input', 'options', 'logs']} className="w-full">
                <AccordionItem value="input">
                  <AccordionTrigger className="px-4 text-sm font-semibold hover:no-underline">
                    <div className="flex w-full justify-between items-center">
                      <span>Input Files (JSON)</span>
                      <span className="text-xs font-normal text-muted-foreground tabular-nums">
                        {tokenCounts.input.toLocaleString()} tokens
                      </span>
                    </div>
                  </AccordionTrigger>
                  <AccordionContent>
                    <div className="px-4 pb-4 h-96">
                      <Textarea
                        value={filesInput}
                        onChange={(e) => setFilesInput(e.currentTarget.value)}
                        className="h-full w-full font-mono text-xs resize-none"
                        placeholder="Paste an array of FileContent objects here..."
                      />
                    </div>
                  </AccordionContent>
                </AccordionItem>

                <AccordionItem value="options">
                  <AccordionTrigger className="px-4 text-sm font-semibold hover:no-underline">Formatting Options</AccordionTrigger>
                  <AccordionContent className="px-4">
                    <OutputOptions options={formattingOptions} setOptions={setFormattingOptions} />
                  </AccordionContent>
                </AccordionItem>

                <AccordionItem value="logs" className="border-b-0">
                  <AccordionTrigger className="px-4 text-sm font-semibold hover:no-underline">Logs</AccordionTrigger>
                  <AccordionContent className="px-4">
                    <LogViewer logs={logs} />
                  </AccordionContent>
                </AccordionItem>
              </Accordion>
            </div>
          </aside>

          {/* Main Content Area */}
          <main className="flex-grow flex flex-col overflow-hidden">
            <div className="flex justify-between items-center p-4 border-b flex-shrink-0">
              <h2 className="text-lg font-semibold leading-none tracking-tight">Output (SCN)</h2>
              <div className="flex items-center gap-4">
                {analysisTime !== null && (
                  <span className="text-sm text-muted-foreground">
                    Analyzed in {(analysisTime / 1000).toFixed(2)}s
                  </span>
                )}
                <span className="text-sm font-normal text-muted-foreground tabular-nums">{tokenCounts.output.toLocaleString()} tokens</span>
                <Button variant="ghost" size="icon" onClick={handleCopy} disabled={!scnOutput} title="Copy to clipboard">
                  {isCopied ? <Check className="h-4 w-4 text-green-500" /> : <Copy className="h-4 w-4" />}
                </Button>
              </div>
            </div>
            <div className="p-4 flex-grow overflow-auto font-mono text-xs">
              <pre className="whitespace-pre-wrap">
                {scnOutput || (isLoading ? "Generating..." : "Output will appear here.")}
              </pre>
            </div>
          </main>
        </div>
      );
    }


    export default App;
  packages/scn-ts-web-demo/src/components/ui/accordion.tsx: |-
    import * as React from "react"
    import * as AccordionPrimitive from "@radix-ui/react-accordion"
    import { ChevronDown } from "lucide-react"

    import { cn } from "../../lib/utils"

    const Accordion = AccordionPrimitive.Root

    const AccordionItem = React.forwardRef<
      React.ElementRef<typeof AccordionPrimitive.Item>,
      React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
    >(({ className, ...props }, ref) => (
      <AccordionPrimitive.Item
        ref={ref}
        className={cn("border-b", className)}
        {...props}
      />
    ))
    AccordionItem.displayName = "AccordionItem"

    const AccordionTrigger = React.forwardRef<
      React.ElementRef<typeof AccordionPrimitive.Trigger>,
      React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
    >(({ className, children, ...props }, ref) => (
      <AccordionPrimitive.Header className="flex">
        <AccordionPrimitive.Trigger
          ref={ref}
          className={cn(
            "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
            className
          )}
          {...props}
        >
          {children}
          <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
        </AccordionPrimitive.Trigger>
      </AccordionPrimitive.Header>
    ))
    AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

    const AccordionContent = React.forwardRef<
      React.ElementRef<typeof AccordionPrimitive.Content>,
      React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
    >(({ className, children, ...props }, ref) => (
      <AccordionPrimitive.Content
        ref={ref}
        className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
        {...props}
      >
        <div className={cn("pb-4 pt-0", className)}>{children}</div>
      </AccordionPrimitive.Content>
    ))

    AccordionContent.displayName = AccordionPrimitive.Content.displayName

    export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
approved: true
