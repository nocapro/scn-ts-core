uuid: d8e5e744-83b3-4fde-bd0f-155e92c6e6e2
projectId: scn-ts-core
createdAt: '2025-09-05T09:13:03.428Z'
linesAdded: 44
linesRemoved: 41
gitCommitMsg: >-
  refactor(web-demo): separate accordion header and trigger to fix button
  nesting
promptSummary: Fixing a React warning about nested buttons in the accordion component.
reasoning:
  - >-
    Sup HN, anton here. Got a report of some React DOM nesting drama, `<button>`
    inside a `<button>`, you know how it is. Turns out our `AccordionTrigger`
    was a bit too greedy, wrapping everything in a button, even other buttons.
    Classic.
  - >-
    I've refactored the accordion component to be more composable. I split out
    `AccordionHeader` from `AccordionTrigger`. Now you can put actions in the
    header right next to the trigger without any illegal nesting. Updated the
    main app view to use the new structure. Should be all good now. Peace.
  - >-
    First, let's fix the `accordion` component. I'm separating the header from
    the trigger to allow for more flexible layouts, like adding action buttons
    next to the trigger.
  - >-
    Now, I'll update `App.tsx` to use the new `AccordionHeader` and fix the
    button nesting issue for the "Formatting Options" section.
operations:
  - type: write
    path: packages/scn-ts-web-demo/src/components/ui/accordion.tsx
    content: >-
      --- packages/scn-ts-web-demo/src/components/ui/accordion.tsx

      +++ packages/scn-ts-web-demo/src/components/ui/accordion.tsx

      @@ -19,23 +19,20 @@
       ))
       AccordionItem.displayName = "AccordionItem"
       
      +const AccordionHeader = React.forwardRef<

      +  React.ElementRef<typeof AccordionPrimitive.Header>,

      +  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Header>

      +>(({ className, ...props }, ref) => <AccordionPrimitive.Header ref={ref}
      className={cn("flex sticky top-0 z-10 border-b bg-background", className)}
      {...props} />);

      +AccordionHeader.displayName = AccordionPrimitive.Header.displayName;

      +
       const AccordionTrigger = React.forwardRef<
         React.ElementRef<typeof AccordionPrimitive.Trigger>,
         React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
       >(({ className, children, ...props }, ref) => (
      -  <AccordionPrimitive.Header className="flex sticky top-0 z-10 border-b
      bg-background">

      -    <AccordionPrimitive.Trigger

      -      ref={ref}

      -      className={cn(

      -        "flex flex-1 items-center justify-between py-4 font-medium
      transition-all hover:underline [&[data-state=open]>svg]:rotate-180",

      -        className

      -      )}

      -      {...props}

      -    >

      -      {children}

      -      <ChevronDown className="h-4 w-4 shrink-0 transition-transform
      duration-200" />

      -    </AccordionPrimitive.Trigger>

      -  </AccordionPrimitive.Header>

      +  <AccordionPrimitive.Trigger ref={ref} className={cn("flex flex-1
      items-center justify-between py-4 font-medium transition-all
      hover:underline [&[data-state=open]>svg]:rotate-180", className)}
      {...props}>

      +    {children}

      +    <ChevronDown className="h-4 w-4 shrink-0 transition-transform
      duration-200" />

      +  </AccordionPrimitive.Trigger>
       ))
       AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName
       
      @@ -53,4 +50,4 @@
       
       AccordionContent.displayName = AccordionPrimitive.Content.displayName
       
      -export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }

      +export { Accordion, AccordionItem, AccordionHeader, AccordionTrigger,
      AccordionContent }
    patchStrategy: new-unified
  - type: write
    path: packages/scn-ts-web-demo/src/App.tsx
    content: >-
      --- packages/scn-ts-web-demo/src/App.tsx

      +++ packages/scn-ts-web-demo/src/App.tsx

      @@ -4,8 +4,8 @@
       import { Textarea } from './components/ui/textarea';
       import LogViewer from './components/LogViewer';
       import OutputOptions, { type OutputOptionsHandle } from './components/OutputOptions';
      -import { Legend } from './components/Legend';

      +import { Legend } from './components/Legend'; 
       import { Play, Loader, Copy, Check, StopCircle, ChevronsDown, ChevronsUp } from 'lucide-react';
      -import { Accordion, AccordionContent, AccordionItem, AccordionTrigger }
      from './components/ui/accordion';

      +import { Accordion, AccordionContent, AccordionItem, AccordionHeader,
      AccordionTrigger } from './components/ui/accordion';
       import { useAnalysis } from './hooks/useAnalysis.hook';
       import { useClipboard } from './hooks/useClipboard.hook';
       import { useResizableSidebar } from './hooks/useResizableSidebar.hook';
      @@ -124,14 +124,16 @@
               <div className="flex-grow overflow-y-auto">
                 <Accordion type="multiple" defaultValue={['input', 'options', 'logs']} className="w-full">
                   <AccordionItem value="input">
      -              <AccordionTrigger className="px-4 text-sm font-semibold
      hover:no-underline">

      -                <div className="flex w-full justify-between
      items-center">

      -                  <span>Input Files (JSON)</span>

      -                  <span className="text-xs font-normal
      text-muted-foreground tabular-nums">

      -                    {tokenCounts.input.toLocaleString()} tokens

      -                  </span>

      -                </div>

      -              </AccordionTrigger>

      +              <AccordionHeader>

      +                <AccordionTrigger className="px-4 text-sm font-semibold
      hover:no-underline">

      +                  <div className="flex w-full justify-between
      items-center">

      +                    <span>Input Files (JSON)</span>

      +                    <span className="text-xs font-normal
      text-muted-foreground tabular-nums">

      +                      {tokenCounts.input.toLocaleString()} tokens

      +                    </span>

      +                  </div>

      +                </AccordionTrigger>

      +              </AccordionHeader>
                     <AccordionContent>
                       <div className="px-4 pb-4 h-96">
                         <Textarea
      @@ -145,39 +147,41 @@
                   </AccordionItem>
       
                   <AccordionItem value="options">
      -              <AccordionTrigger className="px-4 text-sm font-semibold
      hover:no-underline">

      -                <div className="flex w-full justify-between
      items-center">

      -                  <span>Formatting Options</span>

      -                  <div className="flex items-center gap-2">

      -                    {analysisResult && (

      -                      <span className="text-xs font-normal
      text-muted-foreground tabular-nums">

      -                        {visibleSymbols} / {totalSymbols} symbols

      -                      </span>

      -                    )}

      -                    <Button variant="ghost" size="icon"
      onClick={handleExpandOptions} title="Expand all" className="h-7 w-7
      text-muted-foreground hover:text-foreground">

      -                      <ChevronsDown className="h-4 w-4" />

      -                    </Button>

      -                    <Button variant="ghost" size="icon"
      onClick={handleCollapseOptions} title="Collapse all" className="h-7 w-7
      text-muted-foreground hover:text-foreground">

      -                      <ChevronsUp className="h-4 w-4" />

      -                    </Button>

      -                  </div>

      -                </div>

      -              </AccordionTrigger>

      +              <AccordionHeader className="items-center">

      +                <AccordionTrigger className="px-4 text-sm font-semibold
      hover:no-underline">

      +                  <div className="flex w-full items-center
      justify-between">

      +                    <span>Formatting Options</span>

      +                      {analysisResult && (

      +                        <span className="text-xs font-normal
      text-muted-foreground tabular-nums">

      +                          {visibleSymbols} / {totalSymbols} symbols

      +                        </span>

      +                      )}

      +                  </div>

      +                </AccordionTrigger>

      +                <div className="flex items-center gap-2 pr-4">

      +                  <Button variant="ghost" size="icon"
      onClick={handleExpandOptions} title="Expand all" className="h-7 w-7
      text-muted-foreground hover:text-foreground">

      +                    <ChevronsDown className="h-4 w-4" />

      +                  </Button>

      +                  <Button variant="ghost" size="icon"
      onClick={handleCollapseOptions} title="Collapse all" className="h-7 w-7
      text-muted-foreground hover:text-foreground">

      +                    <ChevronsUp className="h-4 w-4" />

      +                  </Button>

      +                </div>

      +              </AccordionHeader>
                     <AccordionContent className="px-4">
                       <OutputOptions ref={outputOptionsRef} options={formattingOptions} setOptions={setFormattingOptions} />
                     </AccordionContent>
                   </AccordionItem>
       
                   <AccordionItem value="logs">
      -              <AccordionTrigger className="px-4 text-sm font-semibold
      hover:no-underline">Logs</AccordionTrigger>

      +              <AccordionHeader>

      +                <AccordionTrigger className="px-4 text-sm font-semibold
      hover:no-underline">Logs</AccordionTrigger>

      +              </AccordionHeader>
                     <AccordionContent className="px-4">
                       <LogViewer logs={logs} />
                     </AccordionContent>
                   </AccordionItem>
                 </Accordion>
               </div>
             </aside>
    patchStrategy: new-unified
snapshot:
  packages/scn-ts-web-demo/src/components/ui/accordion.tsx: |-
    import * as React from "react"
    import * as AccordionPrimitive from "@radix-ui/react-accordion"
    import { ChevronDown } from "lucide-react"

    import { cn } from "../../lib/utils"

    const Accordion = AccordionPrimitive.Root

    const AccordionItem = React.forwardRef<
      React.ElementRef<typeof AccordionPrimitive.Item>,
      React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>
    >(({ className, ...props }, ref) => (
      <AccordionPrimitive.Item
        ref={ref}
        className={cn(className)}
        {...props}
      />
    ))
    AccordionItem.displayName = "AccordionItem"

    const AccordionTrigger = React.forwardRef<
      React.ElementRef<typeof AccordionPrimitive.Trigger>,
      React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>
    >(({ className, children, ...props }, ref) => (
      <AccordionPrimitive.Header className="flex sticky top-0 z-10 border-b bg-background">
        <AccordionPrimitive.Trigger
          ref={ref}
          className={cn(
            "flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180",
            className
          )}
          {...props}
        >
          {children}
          <ChevronDown className="h-4 w-4 shrink-0 transition-transform duration-200" />
        </AccordionPrimitive.Trigger>
      </AccordionPrimitive.Header>
    ))
    AccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName

    const AccordionContent = React.forwardRef<
      React.ElementRef<typeof AccordionPrimitive.Content>,
      React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>
    >(({ className, children, ...props }, ref) => (
      <AccordionPrimitive.Content
        ref={ref}
        className="overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down"
        {...props}
      >
        <div className={cn("pb-4 pt-0", className)}>{children}</div>
      </AccordionPrimitive.Content>
    ))

    AccordionContent.displayName = AccordionPrimitive.Content.displayName

    export { Accordion, AccordionItem, AccordionTrigger, AccordionContent }
  packages/scn-ts-web-demo/src/App.tsx: >
    import { useEffect, useCallback, useMemo, useRef } from 'react';

    import { generateScn, initializeTokenizer, countTokens } from 'scn-ts-core';

    import { Button } from './components/ui/button';

    import { Textarea } from './components/ui/textarea';

    import LogViewer from './components/LogViewer';

    import OutputOptions, { type OutputOptionsHandle } from
    './components/OutputOptions';

    import { Legend } from './components/Legend';

    import { Play, Loader, Copy, Check, StopCircle, ChevronsDown, ChevronsUp }
    from 'lucide-react';

    import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from
    './components/ui/accordion';

    import { useAnalysis } from './hooks/useAnalysis.hook';

    import { useClipboard } from './hooks/useClipboard.hook';

    import { useResizableSidebar } from './hooks/useResizableSidebar.hook';

    import { useAppStore } from './stores/app.store';

    import { cn } from './lib/utils';

    import type { CodeSymbol } from 'scn-ts-core';


    function App() {
      const {
        filesInput,
        setFilesInput,
        scnOutput,
        setScnOutput,
        formattingOptions,
        setFormattingOptions,
      } = useAppStore();

      const {
        isInitialized,
        isLoading,
        analysisResult,
        progress,
        logs,
        analysisTime,
        handleAnalyze: performAnalysis,
        handleStop,
        onLogPartial,
      } = useAnalysis();

      const outputOptionsRef = useRef<OutputOptionsHandle>(null);

      const { sidebarWidth, handleMouseDown } = useResizableSidebar(480);
      const { isCopied, handleCopy: performCopy } = useClipboard();

      useEffect(() => {
        if (!initializeTokenizer()) {
          onLogPartial({ level: 'error', message: 'Failed to initialize tokenizer.' });
        }
      }, [onLogPartial]);

      useEffect(() => {
        if (analysisResult) {
          setScnOutput(generateScn(analysisResult, formattingOptions));
        } else {
          setScnOutput('');
        }
      }, [analysisResult, formattingOptions]);

      const { tokenCounts, tokenReductionPercent } = useMemo(() => {
        const input = countTokens(filesInput);
        const output = countTokens(scnOutput);
        let reductionPercent: number | null = null;
        if (input > 0) {
          reductionPercent = ((input - output) / input) * 100;
        }
        return {
          tokenCounts: { input, output },
          tokenReductionPercent: reductionPercent,
        };
      }, [filesInput, scnOutput]);

      const handleCopy = useCallback(() => {
        performCopy(scnOutput);
      }, [performCopy, scnOutput]);

      const handleAnalyze = useCallback(async () => {
        performAnalysis(filesInput);
      }, [performAnalysis, filesInput]);

      const handleExpandOptions = (e: React.MouseEvent) => {
        e.stopPropagation();
        outputOptionsRef.current?.expandAll();
      };

      const handleCollapseOptions = (e: React.MouseEvent) => {
        e.stopPropagation();
        outputOptionsRef.current?.collapseAll();
      };

      const { totalSymbols, visibleSymbols } = useMemo(() => {
        if (!analysisResult) {
          return { totalSymbols: 0, visibleSymbols: 0 };
        }
        const allSymbols: CodeSymbol[] = analysisResult.flatMap(file => file.symbols);
        const total = allSymbols.length;
        const visible = allSymbols.filter(symbol => {
          return formattingOptions.displayFilters?.[symbol.kind] !== false;
        }).length;
        return { totalSymbols: total, visibleSymbols: visible };
      }, [analysisResult, formattingOptions.displayFilters]);

      return (
        <div className="h-screen w-screen flex bg-background text-foreground overflow-hidden">
          {/* Sidebar */}
          <aside style={{ width: `${sidebarWidth}px` }} className="max-w-[80%] min-w-[320px] flex-shrink-0 flex flex-col border-r">
            <div className="flex-shrink-0 flex items-center justify-between p-4 border-b bg-background relative z-20">
              <h1 className="text-xl font-bold tracking-tight">SCN-TS Web Demo</h1>
              <div className="flex items-center space-x-2">
                {isLoading ? (
                  <>
                    <Button disabled className="w-32 justify-center">
                      <Loader className="mr-2 h-4 w-4 animate-spin" />
                      <span>{progress ? `${Math.round(progress.percentage)}%` : 'Analyzing...'}</span>
                    </Button>
                    <Button onClick={handleStop} variant="outline" size="icon" title="Stop analysis">
                      <StopCircle className="h-4 w-4" />
                    </Button>
                  </>
                ) : (
                  <Button onClick={handleAnalyze} disabled={!isInitialized} className="w-32 justify-center">
                    <Play className="mr-2 h-4 w-4" />
                    <span>Analyze</span>
                  </Button>
                )}
              </div>
            </div>

            <div className="flex-grow overflow-y-auto">
              <Accordion type="multiple" defaultValue={['input', 'options', 'logs']} className="w-full">
                <AccordionItem value="input">
                  <AccordionTrigger className="px-4 text-sm font-semibold hover:no-underline">
                    <div className="flex w-full justify-between items-center">
                      <span>Input Files (JSON)</span>
                      <span className="text-xs font-normal text-muted-foreground tabular-nums">
                        {tokenCounts.input.toLocaleString()} tokens
                      </span>
                    </div>
                  </AccordionTrigger>
                  <AccordionContent>
                    <div className="px-4 pb-4 h-96">
                      <Textarea
                        value={filesInput}
                        onChange={(e) => setFilesInput(e.currentTarget.value)}
                        className="h-full w-full font-mono text-xs resize-none"
                        placeholder="Paste an array of FileContent objects here..."
                      />
                    </div>
                  </AccordionContent>
                </AccordionItem>

                <AccordionItem value="options">
                  <AccordionTrigger className="px-4 text-sm font-semibold hover:no-underline">
                    <div className="flex w-full justify-between items-center">
                      <span>Formatting Options</span>
                      <div className="flex items-center gap-2">
                        {analysisResult && (
                          <span className="text-xs font-normal text-muted-foreground tabular-nums">
                            {visibleSymbols} / {totalSymbols} symbols
                          </span>
                        )}
                        <Button variant="ghost" size="icon" onClick={handleExpandOptions} title="Expand all" className="h-7 w-7 text-muted-foreground hover:text-foreground">
                          <ChevronsDown className="h-4 w-4" />
                        </Button>
                        <Button variant="ghost" size="icon" onClick={handleCollapseOptions} title="Collapse all" className="h-7 w-7 text-muted-foreground hover:text-foreground">
                          <ChevronsUp className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  </AccordionTrigger>
                  <AccordionContent className="px-4">
                    <OutputOptions ref={outputOptionsRef} options={formattingOptions} setOptions={setFormattingOptions} />
                  </AccordionContent>
                </AccordionItem>

                <AccordionItem value="logs">
                  <AccordionTrigger className="px-4 text-sm font-semibold hover:no-underline">Logs</AccordionTrigger>
                  <AccordionContent className="px-4">
                    <LogViewer logs={logs} />
                  </AccordionContent>
                </AccordionItem>
              </Accordion>
            </div>
          </aside>

          {/* Resizer */}
          <div
            role="separator"
            onMouseDown={handleMouseDown}
            className="w-1.5 flex-shrink-0 cursor-col-resize hover:bg-primary/20 transition-colors duration-200"
          />

          {/* Main Content Area */}
          <main className="flex-grow flex flex-col overflow-hidden relative">
            <div className="flex justify-between items-center p-4 border-b flex-shrink-0">
              <h2 className="text-lg font-semibold leading-none tracking-tight">Output (SCN)</h2>
              <div className="flex items-center gap-4">
                {analysisTime !== null && (
                  <span className="text-sm text-muted-foreground">
                    Analyzed in {(analysisTime / 1000).toFixed(2)}s
                  </span>
                )}
                <span className="text-sm font-normal text-muted-foreground tabular-nums">{tokenCounts.output.toLocaleString()} tokens</span>
                {tokenReductionPercent !== null && analysisResult && (
                  <span
                    className={cn(
                      "text-sm font-medium tabular-nums",
                      tokenReductionPercent >= 0 ? "text-green-500" : "text-red-500"
                    )}
                    title="Token count change from input to output"
                  >
                    {tokenReductionPercent >= 0 ? '▼' : '▲'}{' '}
                    {Math.abs(tokenReductionPercent).toFixed(0)}%
                  </span>
                )}
                <Button variant="ghost" size="icon" onClick={handleCopy} disabled={!scnOutput} title="Copy to clipboard">
                  {isCopied ? <Check className="h-4 w-4 text-green-500" /> : <Copy className="h-4 w-4" />}
                </Button>
              </div>
            </div>
            <div className="p-4 flex-grow overflow-auto font-mono text-xs relative">
              <Legend />
              <pre className="whitespace-pre-wrap">
                {scnOutput || (isLoading ? "Generating..." : "Output will appear here.")}
              </pre>
            </div>
          </main>
        </div>
      );
    }


    export default App;
approved: true
