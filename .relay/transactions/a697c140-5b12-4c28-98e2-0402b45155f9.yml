uuid: a697c140-5b12-4c28-98e2-0402b45155f9
projectId: scn-ts-core
createdAt: '2025-09-04T17:42:16.636Z'
linesAdded: 49
linesRemoved: 55
gitCommitMsg: 'refactor(web-demo): implement sidebar layout'
promptSummary: Refactor web demo to a sidebar layout.
reasoning:
  - >-
    yo, check it. i'm refactoring the web demo layout to be more IDE-like.
    sidebar for controls, main view for the SCN output. should be a much better
    UX.
  - >-
    first, i'll update `LogViewer.tsx` to behave like a standard card component.
    it was doing some weird style overrides before that we don't need with the
    new layout.
  - >-
    next, the main event: gutting `App.tsx` and rebuilding it with the new
    sidebar layout. i'm ripping out the old header and the multi-column main
    area. the new structure will be a flex container with a fixed-width sidebar
    on the left and a dominant main content area for the output on the right.
    this is a complete overhaul of the `return` statement.
operations:
  - type: write
    path: packages/scn-ts-web-demo/src/components/LogViewer.tsx
    content: >-
      --- packages/scn-ts-web-demo/src/components/LogViewer.tsx

      +++ packages/scn-ts-web-demo/src/components/LogViewer.tsx

      @@ -14,7 +14,7 @@
         }, [logs]);
       
         return (
      -    <Card className="h-full flex flex-col border-0 rounded-none
      bg-transparent">

      +    <Card className="h-full flex flex-col">
             <CardHeader className="py-2 px-4">
               <CardTitle>Logs</CardTitle>
             </CardHeader>
    patchStrategy: new-unified
  - type: write
    path: packages/scn-ts-web-demo/src/App.tsx
    content: >-
      --- packages/scn-ts-web-demo/src/App.tsx

      +++ packages/scn-ts-web-demo/src/App.tsx

      @@ -134,56 +134,62 @@
         }, [filesInput, isInitialized]);
       
         return (
      -    <div className="h-screen w-screen flex flex-col bg-background
      text-foreground">

      -      <header className="flex-shrink-0 flex items-center justify-between
      p-4 border-b">

      -        <h1 className="text-xl font-bold tracking-tight">SCN-TS Web
      Demo</h1>

      -        <Button onClick={handleAnalyze} disabled={isLoading ||
      !isInitialized} className="w-32 justify-center">

      -          {isLoading ? (

      -            <>

      -              <Loader className="mr-2 h-4 w-4 animate-spin" />

      -              <span>{progress ? `${Math.round(progress.percentage)}%` :
      'Analyzing...'}</span>

      -            </>

      -          ) : (

      -            <>

      -              <Play className="mr-2 h-4 w-4" />

      -              <span>Analyze</span>

      -            </>

      -          )}

      -        </Button>

      -      </header>

      -

      -      <main className="flex-grow flex flex-col gap-4 p-4
      overflow-hidden">

      -        <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-4
      overflow-hidden min-h-0">

      -          {/* Column 1: Input & Options */}

      -          <div className="lg:col-span-1 flex flex-col gap-4
      overflow-hidden min-h-0">

      -            <Card className="flex flex-col overflow-hidden flex-grow">

      -              <CardHeader>

      -                <CardTitle className="flex justify-between items-center">

      -                  <span>Input Files (JSON)</span>

      -                  <span className="text-sm font-normal
      text-muted-foreground">{tokenCounts.input.toLocaleString()} tokens</span>

      -                </CardTitle>

      -              </CardHeader>

      -              <CardContent className="flex-grow">

      -                <Textarea

      -                  value={filesInput}

      -                  onChange={(e) => setFilesInput(e.currentTarget.value)}

      -                  className="h-full w-full font-mono text-xs resize-none"

      -                  placeholder="Paste an array of FileContent objects
      here..."

      -                />

      -              </CardContent>

      -            </Card>

      -            <OutputOptions options={formattingOptions}
      setOptions={setFormattingOptions} />

      +    <div className="h-screen w-screen flex bg-background
      text-foreground">

      +      {/* Sidebar */}

      +      <aside className="w-[30rem] max-w-[40%] flex-shrink-0 flex flex-col
      border-r">

      +        <div className="flex-shrink-0 flex items-center justify-between
      p-4 border-b">

      +          <h1 className="text-xl font-bold tracking-tight">SCN-TS Web
      Demo</h1>

      +          <Button onClick={handleAnalyze} disabled={isLoading ||
      !isInitialized} className="w-32 justify-center">

      +            {isLoading ? (

      +              <>

      +                <Loader className="mr-2 h-4 w-4 animate-spin" />

      +                <span>{progress ? `${Math.round(progress.percentage)}%` :
      'Analyzing...'}</span>

      +              </>

      +            ) : (

      +              <>

      +                <Play className="mr-2 h-4 w-4" />

      +                <span>Analyze</span>

      +              </>

      +            )}

      +          </Button>

      +        </div>

      +

      +        <div className="flex-grow overflow-y-auto p-4 flex flex-col
      gap-4">

      +          <Card className="flex flex-col min-h-96">

      +            <CardHeader>

      +              <CardTitle className="flex justify-between items-center">

      +                <span>Input Files (JSON)</span>

      +                <span className="text-sm font-normal
      text-muted-foreground">{tokenCounts.input.toLocaleString()} tokens</span>

      +              </CardTitle>

      +            </CardHeader>

      +            <CardContent className="flex-grow">

      +              <Textarea

      +                value={filesInput}

      +                onChange={(e) => setFilesInput(e.currentTarget.value)}

      +                className="h-full w-full font-mono text-xs resize-none"

      +                placeholder="Paste an array of FileContent objects
      here..."

      +              />

      +            </CardContent>

      +          </Card>

      +          <OutputOptions options={formattingOptions}
      setOptions={setFormattingOptions} />

      +          <div className="min-h-60">

      +            <LogViewer logs={logs} />
                 </div>
      -

      -          {/* Column 2 & 3: Output */}

      -          <Card className="lg:col-span-2 flex flex-col overflow-hidden
      min-h-0">

      -            <CardHeader>

      -              <div className="flex justify-between items-center">

      -                <CardTitle>Output (SCN)</CardTitle>

      -                <span className="text-sm font-normal
      text-muted-foreground tabular-nums">{tokenCounts.output.toLocaleString()}
      tokens</span>

      -              </div>

      -            </CardHeader>

      -            <CardContent className="flex-grow overflow-auto">

      -              <pre className="text-xs whitespace-pre-wrap font-mono
      h-full w-full">

      -                <code className="h-full w-full">

      -                  {scnOutput || (isLoading ? "Generating..." : "Output
      will appear here.")}

      -                </code>

      -              </pre>

      -            </CardContent>

      -          </Card>

      -        </div>

      -        <div className="flex-shrink-0 h-1/3 max-h-[25rem] border
      rounded-lg overflow-hidden">

      -          <LogViewer logs={logs} />

      -        </div>

      +        </div>

      +      </aside>

      +

      +      {/* Main Content Area */}

      +      <main className="flex-grow flex flex-col overflow-hidden">

      +        <div className="flex justify-between items-center p-4 border-b
      flex-shrink-0">

      +          <CardTitle>Output (SCN)</CardTitle>

      +          <span className="text-sm font-normal text-muted-foreground
      tabular-nums">{tokenCounts.output.toLocaleString()} tokens</span>

      +        </div>

      +        <div className="p-4 flex-grow overflow-auto font-mono text-xs">

      +          <pre className="whitespace-pre-wrap">

      +            {scnOutput || (isLoading ? "Generating..." : "Output will
      appear here.")}

      +          </pre>

      +        </div>
             </main>
           </div>
         );
       }
    patchStrategy: new-unified
snapshot:
  packages/scn-ts-web-demo/src/components/LogViewer.tsx: |
    import React, { useEffect, useRef } from 'react';
    import { Card, CardContent, CardHeader, CardTitle } from './ui/card';
    import { cn } from '../lib/utils';
    import type { LogEntry } from '../types';
    import { levelColorMap } from '../constants';

    const LogViewer: React.FC<{ logs: readonly LogEntry[] }> = ({ logs }) => {
      const scrollContainerRef = useRef<HTMLDivElement>(null);

      useEffect(() => {
        if (scrollContainerRef.current) {
          scrollContainerRef.current.scrollTop = scrollContainerRef.current.scrollHeight;
        }
      }, [logs]);

      return (
        <Card className="h-full flex flex-col border-0 rounded-none bg-transparent">
          <CardHeader className="py-2 px-4">
            <CardTitle>Logs</CardTitle>
          </CardHeader>
          <CardContent ref={scrollContainerRef} className="flex-grow overflow-auto p-0">
            <div className="px-4 pb-4 pt-0 font-mono text-xs">
              {logs.length === 0 && <p className="text-muted-foreground">No logs yet. Click "Analyze" to start.</p>}
              {logs.map((log, index) => (
                <div key={index} className="flex items-start">
                  <span className="text-muted-foreground/80 mr-4 flex-shrink-0">
                    {new Date(log.timestamp).toLocaleTimeString()}
                  </span>
                  <span className={cn("font-bold w-14 flex-shrink-0", levelColorMap[log.level])}>
                    [{log.level.toUpperCase()}]
                  </span>
                  <span className="whitespace-pre-wrap break-all text-foreground">{log.message}</span>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      );
    };

    export default LogViewer;
  packages/scn-ts-web-demo/src/App.tsx: >
    import { useState, useEffect, useCallback } from 'react';

    import { get_encoding, type Tiktoken } from 'tiktoken';

    import {
      initializeParser,
      logger,
      analyzeProject,
      generateScn,
    } from '../../../index';

    import type { FileContent, LogHandler, SourceFile } from '../../../index';

    import { defaultFilesJSON } from './default-files';

    import { Button } from './components/ui/button';

    import { Card, CardContent, CardHeader, CardTitle } from
    './components/ui/card';

    import { Textarea } from './components/ui/textarea';

    import LogViewer from './components/LogViewer';

    import OutputOptions from './components/OutputOptions';

    import { Play, Loader } from 'lucide-react';

    import type { LogEntry, ProgressData, FormattingOptions } from './types';


    function App() {
      const [isInitialized, setIsInitialized] = useState(false);
      const [isLoading, setIsLoading] = useState(false);
      const [filesInput, setFilesInput] = useState(defaultFilesJSON);
      const [scnOutput, setScnOutput] = useState('');
      const [analysisResult, setAnalysisResult] = useState<SourceFile[] | null>(null);
      const [formattingOptions, setFormattingOptions] = useState<FormattingOptions>({
        showOutgoing: true,
        showIncoming: true,
        showIcons: true,
        showVisibility: true,
        showModifiers: true,
        showTags: true,
        showSymbolIds: true,
      });
      const [progress, setProgress] = useState<ProgressData | null>(null);
      const [logs, setLogs] = useState<LogEntry[]>([]);
      const [encoder, setEncoder] = useState<Tiktoken | null>(null);
      const [tokenCounts, setTokenCounts] = useState({ input: 0, output: 0 });

      useEffect(() => {
        const init = async () => {
          try {
            await initializeParser({ wasmBaseUrl: '/wasm/' });
            const enc = get_encoding("cl100k_base");
            setEncoder(enc);
            setIsInitialized(true);
            setLogs(prev => [...prev, { level: 'info', message: 'Parser and tokenizer initialized.', timestamp: Date.now() }]);
          } catch (error) {
            const message = error instanceof Error ? error.message : String(error);
            setLogs(prev => [...prev, { level: 'error', message: `Failed to initialize: ${message}`, timestamp: Date.now() }]);
          }
        };
        init();
      }, []);

      useEffect(() => {
        if (!encoder) return;
        try {
          const inputTokens = encoder.encode(filesInput).length;
          const outputTokens = encoder.encode(scnOutput).length;
          setTokenCounts({ input: inputTokens, output: outputTokens });
        } catch (e) {
          console.error("Tokenization error:", e);
          setTokenCounts({ input: 0, output: 0 });
        }
      }, [filesInput, scnOutput, encoder]);

      useEffect(() => {
        if (analysisResult) {
          const scn = generateScn(analysisResult, formattingOptions);
          setScnOutput(scn);
        }
      }, [analysisResult, formattingOptions]);

      const handleAnalyze = useCallback(async () => {
        if (!isInitialized) {
          setLogs(prev => [...prev, { level: 'warn', message: 'Parser not ready.', timestamp: Date.now() }]);
          return;
        }

        setIsLoading(true);
        setLogs([]);
        setScnOutput('');
        setAnalysisResult(null);
        setProgress(null);

        const logHandler: LogHandler = (level, ...args) => {
          const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : String(arg)).join(' ');
          setLogs(prev => [...prev, { level, message, timestamp: Date.now() }]);
        };
        logger.setLogHandler(logHandler);
        logger.setLevel('debug');

        const onProgress = (progressData: ProgressData) => {
          setProgress(progressData);
          logger.info(`[${Math.round(progressData.percentage)}%] ${progressData.message}`);
        };

        try {
          let files: FileContent[] = [];
          try {
            files = JSON.parse(filesInput);
            if (!Array.isArray(files)) throw new Error("Input is not an array.");
          } catch (error) {
            throw new Error(`Invalid JSON input: ${error instanceof Error ? error.message : String(error)}`);
          }

          const rankedGraph = await analyzeProject({ files, onProgress, logLevel: 'debug' });
          setAnalysisResult(rankedGraph);
          logger.info('Analysis complete.');
        } catch (error) {
          const message = error instanceof Error ? error.message : String(error);
          logger.error('Analysis failed:', message);
        } finally {
          setIsLoading(false);
          setProgress(null);
          logger.setLogHandler(null);
        }
      }, [filesInput, isInitialized]);

      return (
        <div className="h-screen w-screen flex flex-col bg-background text-foreground">
          <header className="flex-shrink-0 flex items-center justify-between p-4 border-b">
            <h1 className="text-xl font-bold tracking-tight">SCN-TS Web Demo</h1>
            <Button onClick={handleAnalyze} disabled={isLoading || !isInitialized} className="w-32 justify-center">
              {isLoading ? (
                <>
                  <Loader className="mr-2 h-4 w-4 animate-spin" />
                  <span>{progress ? `${Math.round(progress.percentage)}%` : 'Analyzing...'}</span>
                </>
              ) : (
                <>
                  <Play className="mr-2 h-4 w-4" />
                  <span>Analyze</span>
                </>
              )}
            </Button>
          </header>

          <main className="flex-grow flex flex-col gap-4 p-4 overflow-hidden">
            <div className="flex-grow grid grid-cols-1 lg:grid-cols-3 gap-4 overflow-hidden min-h-0">
              {/* Column 1: Input & Options */}
              <div className="lg:col-span-1 flex flex-col gap-4 overflow-hidden min-h-0">
                <Card className="flex flex-col overflow-hidden flex-grow">
                  <CardHeader>
                    <CardTitle className="flex justify-between items-center">
                      <span>Input Files (JSON)</span>
                      <span className="text-sm font-normal text-muted-foreground">{tokenCounts.input.toLocaleString()} tokens</span>
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="flex-grow">
                    <Textarea
                      value={filesInput}
                      onChange={(e) => setFilesInput(e.currentTarget.value)}
                      className="h-full w-full font-mono text-xs resize-none"
                      placeholder="Paste an array of FileContent objects here..."
                    />
                  </CardContent>
                </Card>
                <OutputOptions options={formattingOptions} setOptions={setFormattingOptions} />
              </div>

              {/* Column 2 & 3: Output */}
              <Card className="lg:col-span-2 flex flex-col overflow-hidden min-h-0">
                <CardHeader>
                  <div className="flex justify-between items-center">
                    <CardTitle>Output (SCN)</CardTitle>
                    <span className="text-sm font-normal text-muted-foreground tabular-nums">{tokenCounts.output.toLocaleString()} tokens</span>
                  </div>
                </CardHeader>
                <CardContent className="flex-grow overflow-auto">
                  <pre className="text-xs whitespace-pre-wrap font-mono h-full w-full">
                    <code className="h-full w-full">
                      {scnOutput || (isLoading ? "Generating..." : "Output will appear here.")}
                    </code>
                  </pre>
                </CardContent>
              </Card>
            </div>
            <div className="flex-shrink-0 h-1/3 max-h-[25rem] border rounded-lg overflow-hidden">
              <LogViewer logs={logs} />
            </div>
          </main>
        </div>
      );
    }


    export default App;
approved: true
