uuid: 4a3e8b09-3221-4f16-95f0-6818129990de
projectId: scn-ts-core
createdAt: '2025-09-05T04:24:09.200Z'
linesAdded: 193
linesRemoved: 0
gitCommitMsg: 'refactor(web-demo): extract component logic into custom hooks'
promptSummary: >-
  Refactor App.tsx by extracting logic into custom hooks to separate concerns
  and simplify the main component.
reasoning:
  - >-
    Alright, let's clean this up. A well-structured app is a happy app. Moving
    all that logic out of the main `App.tsx` component into some tidy hooks will
    make things much easier to reason about. It's good practice to keep your
    components focused on rendering, and this is a classic case of a component
    doing way too much.
  - >-
    First, I'll create a new `hooks` directory and start moving logic into
    custom hooks.
  - '### Create `useResizableSidebar` hook'
  - >-
    This hook will encapsulate the logic for resizing the sidebar. It's a neat
    little piece of reusable UI logic.
  - '### Create `useClipboard` hook'
  - A simple hook for handling the copy-to-clipboard functionality.
  - '### Create `useAnalysis` hook'
  - >-
    This is the big one. It will manage the entire analysis process, including
    worker communication, state for loading, progress, logs, and results. This
    will drastically simplify the `App` component.
  - '### Create `useTokenCounter` hook'
  - >-
    This hook will handle token counting, including the initialization of the
    tokenizer. It will report errors through a callback.
  - '### Refactor `App.tsx`'
  - >-
    Now for the payoff. I'll refactor `App.tsx` to use our new hooks. Look how
    much cleaner it becomes!
  - '```typescript // packages/scn-ts-web-demo/src/App.tsx new-unified'
  - '--- packages/scn-ts-web-demo/src/App.tsx'
  - +++ packages/scn-ts-web-demo/src/App.tsx
  - '@@ -1,19 +1,22 @@'
  - '-import { useState, useEffect, useCallback, useRef } from ''react'';'
  - '-import { get_encoding, type Tiktoken } from ''tiktoken'';'
  - '-import * as Comlink from ''comlink'';'
  - '-import type { Remote } from ''comlink'';'
  - +import { useState, useEffect } from 'react';
  - import { generateScn } from 'scn-ts-core';
  - import type { SourceFile } from 'scn-ts-core';
  - import { defaultFilesJSON } from './default-files';
  - import { Button } from './components/ui/button';
  - import { Textarea } from './components/ui/textarea';
  - import LogViewer from './components/LogViewer';
  - import OutputOptions from './components/OutputOptions';
  - import { Legend } from './components/Legend';
  - import { Play, Loader, Copy, Check, StopCircle } from 'lucide-react';
  - '-import type { LogEntry, ProgressData, FormattingOptions } from ''./types'';'
  - '-import type { WorkerApi } from ''./worker'';'
  - +import type { FormattingOptions } from './types';
  - >-
    import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from
    './components/ui/accordion';
  - +import { useAnalysis } from './hooks/useAnalysis.hook';
  - +import { useResizableSidebar } from './hooks/useResizableSidebar.hook';
  - +import { useClipboard } from './hooks/useClipboard.hook';
  - +import { useTokenCounter } from './hooks/useTokenCounter.hook';
  - function App() {
  - '-  const [isInitialized, setIsInitialized] = useState(false);'
  - '-  const [isLoading, setIsLoading] = useState(false);'
  - '-  const [sidebarWidth, setSidebarWidth] = useState(480);'
  - const [filesInput, setFilesInput] = useState(defaultFilesJSON);
  - const [scnOutput, setScnOutput] = useState('');
  - >-
    -  const [analysisResult, setAnalysisResult] = useState<SourceFile[] |
    null>(null);
  - '-  const [isCopied, setIsCopied] = useState(false);'
  - >-
    const [formattingOptions, setFormattingOptions] =
    useState<FormattingOptions>({
  - 'showOutgoing: true,'
  - 'showIncoming: true,'
  - '@@ -27,152 +30,34 @@'
  - 'showFilePrefix: true,'
  - 'showFileIds: true,'
  - '});'
  - '-  const [progress, setProgress] = useState<ProgressData | null>(null);'
  - '-  const [logs, setLogs] = useState<LogEntry[]>([]);'
  - '-  const [encoder, setEncoder] = useState<Tiktoken | null>(null);'
  - '-  const [analysisTime, setAnalysisTime] = useState<number | null>(null);'
  - '-  const [tokenCounts, setTokenCounts] = useState({ input: 0, output: 0 });'
  - '-'
  - '-  const isResizing = useRef(false);'
  - '-  const workerRef = useRef<Remote<WorkerApi> | null>(null);'
  - +
  - +  const {
  - +    isInitialized,
  - +    isLoading,
  - +    analysisResult,
  - +    progress,
  - +    logs,
  - +    analysisTime,
  - +    handleAnalyze,
  - +    handleStop,
  - +    onLogPartial,
  - +  } = useAnalysis();
  - +
  - +  const { sidebarWidth, handleMouseDown } = useResizableSidebar(480);
  - +  const { isCopied, handleCopy } = useClipboard();
  - +  const tokenCounts = useTokenCounter(filesInput, scnOutput, onLogPartial);
  - useEffect(() => {
  - '-    // Initialize Tokenizer on main thread'
  - '-    try {'
  - '-      const enc = get_encoding("cl100k_base");'
  - '-      setEncoder(enc);'
  - '-    } catch (e) {'
  - '-      console.error("Failed to initialize tokenizer:", e);'
  - >-
    -      setLogs(prev => [...prev, { level: 'error', message: 'Failed to
    initialize tokenizer.', timestamp: Date.now() }]);
  - +    if (analysisResult) {
  - +      setScnOutput(generateScn(analysisResult, formattingOptions));
  - +    } else {
  - +      setScnOutput('');
  - '}'
  - '-'
  - '-    // Comlink setup'
  - >-
    -    const worker = new Worker(new URL('./worker.ts', import.meta.url), {
    type: 'module' });
  - '-    const wrappedWorker = Comlink.wrap<WorkerApi>(worker);'
  - '-    workerRef.current = wrappedWorker;'
  - '-'
  - '-    const initializeWorker = async () => {'
  - '-      try {'
  - '-        await wrappedWorker.init();'
  - '-        setIsInitialized(true);'
  - >-
    -        setLogs(prev => [...prev, { level: 'info', message: 'Analysis
    worker ready.', timestamp: Date.now() }]);
  - '-      } catch (error) {'
  - >-
    -        const message = error instanceof Error ? error.message :
    String(error);
  - >-
    -        setLogs(prev => [...prev, { level: 'error', message: `Worker failed
    to initialize: ${message}`, timestamp: Date.now() }]);
  - '-      }'
  - '-    };'
  - '-'
  - '-    initializeWorker();'
  - '-'
  - '-    return () => {'
  - '-      wrappedWorker[Comlink.releaseProxy]();'
  - '-      worker.terminate();'
  - '-    };'
  - '-  }, []);'
  - '-'
  - '-  useEffect(() => {'
  - '-    if (!encoder) return;'
  - '-    try {'
  - '-      const inputTokens = encoder.encode(filesInput).length;'
  - '-      const outputTokens = encoder.encode(scnOutput).length;'
  - '-      setTokenCounts({ input: inputTokens, output: outputTokens });'
  - '-    } catch (e) {'
  - '-      console.error("Tokenization error:", e);'
  - '-      setTokenCounts({ input: 0, output: 0 });'
  - '-    }'
  - '-  }, [filesInput, scnOutput, encoder]);'
  - '-'
  - '-  useEffect(() => {'
  - '-    if (analysisResult) {'
  - '-      setScnOutput(generateScn(analysisResult, formattingOptions));'
  - '-    }'
  - '}, [analysisResult, formattingOptions]);'
  - '-  const handleCopy = useCallback(() => {'
  - '-    if (scnOutput) {'
  - '-      navigator.clipboard.writeText(scnOutput).then('
  - '-        () => {'
  - '-          setIsCopied(true);'
  - '-          setTimeout(() => setIsCopied(false), 2000);'
  - '-        }'
  - '-      );'
  - '-    }'
  - '-  }, [scnOutput]);'
  - '-'
  - '-  const handleStop = useCallback(() => {'
  - '-    if (isLoading && workerRef.current) {'
  - '-      workerRef.current.cancel();'
  - >-
    -      // The error propagation and finally block in handleAnalyze will
    handle state updates.
  - '-    }'
  - '-  }, [isLoading]);'
  - '-'
  - '-  const handleMouseDown = useCallback((e: React.MouseEvent) => {'
  - '-    e.preventDefault();'
  - '-    isResizing.current = true;'
  - '-    document.body.style.cursor = ''col-resize'';'
  - '-    document.body.style.userSelect = ''none'';'
  - '-'
  - '-    const handleMouseMove = (event: MouseEvent) => {'
  - '-      if (isResizing.current) {'
  - '-        const newWidth = event.clientX;'
  - '-        const minWidth = 320; // 20rem'
  - '-        const maxWidth = window.innerWidth * 0.8;'
  - '-        setSidebarWidth(Math.min(maxWidth, Math.max(minWidth, newWidth)));'
  - '-      }'
  - '-    };'
  - '-'
  - '-    const handleMouseUp = () => {'
  - '-      isResizing.current = false;'
  - '-      document.body.style.cursor = '''';'
  - '-      document.body.style.userSelect = '''';'
  - '-      window.removeEventListener(''mousemove'', handleMouseMove);'
  - '-      window.removeEventListener(''mouseup'', handleMouseUp);'
  - '-    };'
  - '-'
  - '-    window.addEventListener(''mousemove'', handleMouseMove);'
  - '-    window.addEventListener(''mouseup'', handleMouseUp);'
  - '-  }, []);'
  - '-'
  - '-  const resetAnalysisState = useCallback(() => {'
  - '-    setScnOutput('''');'
  - '-    setAnalysisResult(null);'
  - '-    setAnalysisTime(null);'
  - '-    setProgress(null);'
  - '-    setLogs([]);'
  - '-  }, []);'
  - '-'
  - '-  const handleAnalyze = useCallback(async () => {'
  - '-    if (!isInitialized || !workerRef.current) {'
  - >-
    -      setLogs(prev => [...prev, { level: 'warn', message: 'Analysis worker
    not ready.', timestamp: Date.now() }]);
  - '-      return;'
  - '-    }'
  - '-'
  - '-    if (isLoading) {'
  - '-      return; // Prevent multiple concurrent analyses'
  - '-    }'
  - '-'
  - '-    setIsLoading(true);'
  - '-    resetAnalysisState();'
  - '-    const onLog = (log: LogEntry) => {'
  - '-      setLogs(prev => [...prev, log]);'
  - '-    };'
  - '-'
  - '-    try {'
  - '-      const { result, analysisTime } = await workerRef.current.analyze('
  - '-        { filesInput, logLevel: ''debug'' },'
  - '-        Comlink.proxy(setProgress),'
  - '-        Comlink.proxy(onLog)'
  - '-      );'
  - '-      setAnalysisResult(result);'
  - '-      setAnalysisTime(analysisTime);'
  - '-    } catch (error) {'
  - >-
    -      const message = error instanceof Error ? error.message :
    String(error);
  - '-      if ((error as Error).name === ''AbortError'') {'
  - >-
    -        setLogs(prev => [...prev, { level: 'warn', message: 'Analysis
    canceled by user.', timestamp: Date.now() }]);
  - '-      } else {'
  - >-
    -        setLogs(prev => [...prev, { level: 'error', message: `Analysis
    error: ${message}`, timestamp: Date.now() }]);
  - '-      }'
  - '-    } finally {'
  - '-      setIsLoading(false);'
  - '-      setProgress(null);'
  - '-    }'
  - '-  }, [filesInput, isInitialized, isLoading, resetAnalysisState]);'
  - '-'
  - return (
  - >-
    <div className="h-screen w-screen flex bg-background text-foreground
    overflow-hidden">
  - '{/* Sidebar */}'
  - '@@ -190,7 +75,7 @@'
  - </Button>
  - </>
  - ') : ('
  - >-
    -              <Button onClick={handleAnalyze} disabled={!isInitialized}
    className="w-32 justify-center">
  - >-
    +              <Button onClick={() => handleAnalyze(filesInput)}
    disabled={!isInitialized} className="w-32 justify-center">
  - <Play className="mr-2 h-4 w-4" />
  - <span>Analyze</span>
  - </Button>
  - '@@ -253,7 +138,7 @@'
  - </span>
  - )}
  - >-
    <span className="text-sm font-normal text-muted-foreground
    tabular-nums">{tokenCounts.output.toLocaleString()} tokens</span>
  - >-
    -            <Button variant="ghost" size="icon" onClick={handleCopy}
    disabled={!scnOutput} title="Copy to clipboard">
  - >-
    +            <Button variant="ghost" size="icon" onClick={() =>
    handleCopy(scnOutput)} disabled={!scnOutput} title="Copy to clipboard">
  - >-
    {isCopied ? <Check className="h-4 w-4 text-green-500" /> : <Copy
    className="h-4 w-4" />}
  - </Button>
  - </div>
operations:
  - type: write
    path: packages/scn-ts-web-demo/src/hooks/useResizableSidebar.hook.ts
    content: >-
      import { useState, useCallback, useRef } from 'react';


      export function useResizableSidebar(initialWidth: number, minWidth = 320,
      maxWidthPercent = 0.8) {
        const [sidebarWidth, setSidebarWidth] = useState(initialWidth);
        const isResizing = useRef(false);

        const handleMouseDown = useCallback((e: React.MouseEvent) => {
          e.preventDefault();
          isResizing.current = true;
          document.body.style.cursor = 'col-resize';
          document.body.style.userSelect = 'none';

          const handleMouseMove = (event: MouseEvent) => {
            if (isResizing.current) {
              const newWidth = event.clientX;
              const maxWidth = window.innerWidth * maxWidthPercent;
              setSidebarWidth(Math.min(maxWidth, Math.max(minWidth, newWidth)));
            }
          };

          const handleMouseUp = () => {
            isResizing.current = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            window.removeEventListener('mousemove', handleMouseMove);
            window.removeEventListener('mouseup', handleMouseUp);
          };

          window.addEventListener('mousemove', handleMouseMove);
          window.addEventListener('mouseup', handleMouseUp);
        }, [minWidth, maxWidthPercent]);

        return { sidebarWidth, handleMouseDown };
      }
    patchStrategy: replace
  - type: write
    path: packages/scn-ts-web-demo/src/hooks/useClipboard.hook.ts
    content: |-
      import { useState, useCallback } from 'react';

      export function useClipboard(timeout = 2000) {
        const [isCopied, setIsCopied] = useState(false);

        const handleCopy = useCallback((text: string) => {
          if (text) {
            navigator.clipboard.writeText(text).then(() => {
              setIsCopied(true);
              setTimeout(() => setIsCopied(false), timeout);
            });
          }
        }, [timeout]);

        return { isCopied, handleCopy };
      }
    patchStrategy: replace
  - type: write
    path: packages/scn-ts-web-demo/src/hooks/useAnalysis.hook.ts
    content: |-
      import { useState, useEffect, useCallback, useRef } from 'react';
      import * as Comlink from 'comlink';
      import type { Remote } from 'comlink';
      import type { SourceFile } from 'scn-ts-core';
      import type { LogEntry, ProgressData } from '../types';
      import type { WorkerApi } from '../worker';

      export function useAnalysis() {
        const [isInitialized, setIsInitialized] = useState(false);
        const [isLoading, setIsLoading] = useState(false);
        const [analysisResult, setAnalysisResult] = useState<SourceFile[] | null>(null);
        const [progress, setProgress] = useState<ProgressData | null>(null);
        const [logs, setLogs] = useState<LogEntry[]>([]);
        const [analysisTime, setAnalysisTime] = useState<number | null>(null);
        const workerRef = useRef<Remote<WorkerApi> | null>(null);

        const onLog = useCallback((log: LogEntry) => {
          setLogs(prev => [...prev, log]);
        }, []);

        const onLogPartial = useCallback((log: Pick<LogEntry, 'level' | 'message'>) => {
          onLog({ ...log, timestamp: Date.now() });
        }, [onLog]);

        useEffect(() => {
          const worker = new Worker(new URL('../worker.ts', import.meta.url), { type: 'module' });
          const wrappedWorker = Comlink.wrap<WorkerApi>(worker);
          workerRef.current = wrappedWorker;

          const initializeWorker = async () => {
            try {
              await wrappedWorker.init();
              setIsInitialized(true);
              onLogPartial({ level: 'info', message: 'Analysis worker ready.' });
            } catch (error) {
              const message = error instanceof Error ? error.message : String(error);
              onLogPartial({ level: 'error', message: `Worker failed to initialize: ${message}` });
            }
          };

          initializeWorker();

          return () => {
            wrappedWorker[Comlink.releaseProxy]();
            worker.terminate();
          };
        }, [onLogPartial]);

        const resetAnalysisState = useCallback(() => {
          setAnalysisResult(null);
          setAnalysisTime(null);
          setProgress(null);
          setLogs([]);
        }, []);

        const handleAnalyze = useCallback(async (filesInput: string) => {
          if (!isInitialized || !workerRef.current) {
            onLogPartial({ level: 'warn', message: 'Analysis worker not ready.' });
            return;
          }
          
          if (isLoading) {
            return; // Prevent multiple concurrent analyses
          }
          
          setIsLoading(true);
          resetAnalysisState();
          
          try {
            const { result, analysisTime } = await workerRef.current.analyze(
              { filesInput, logLevel: 'debug' },
              Comlink.proxy(setProgress),
              Comlink.proxy(onLog)
            );
            setAnalysisResult(result);
            setAnalysisTime(analysisTime);
          } catch (error) {
            const message = error instanceof Error ? error.message : String(error);
            if ((error as Error).name === 'AbortError') {
              onLogPartial({ level: 'warn', message: 'Analysis canceled by user.' });
            } else {
              onLogPartial({ level: 'error', message: `Analysis error: ${message}` });
            }
          } finally {
            setIsLoading(false);
            setProgress(null);
          }
        }, [isInitialized, isLoading, resetAnalysisState, onLog, onLogPartial]);

        const handleStop = useCallback(() => {
          if (isLoading && workerRef.current) {
            workerRef.current.cancel();
          }
        }, [isLoading]);

        return {
          isInitialized,
          isLoading,
          analysisResult,
          progress,
          logs,
          analysisTime,
          handleAnalyze,
          handleStop,
          onLogPartial,
        };
      }
    patchStrategy: replace
  - type: write
    path: packages/scn-ts-web-demo/src/hooks/useTokenCounter.hook.ts
    content: |-
      import { useState, useEffect } from 'react';
      import { get_encoding, type Tiktoken } from 'tiktoken';
      import type { LogEntry } from '../types';

      export function useTokenCounter(
        filesInput: string,
        scnOutput: string,
        onLog: (log: Pick<LogEntry, 'level' | 'message'>) => void
      ) {
        const [encoder, setEncoder] = useState<Tiktoken | null>(null);
        const [tokenCounts, setTokenCounts] = useState({ input: 0, output: 0 });

        useEffect(() => {
          try {
            const enc = get_encoding("cl100k_base");
            setEncoder(enc);
          } catch (e) {
            console.error("Failed to initialize tokenizer:", e);
            onLog({ level: 'error', message: 'Failed to initialize tokenizer.' });
          }
        }, [onLog]);

        useEffect(() => {
          if (!encoder) return;
          try {
            const inputTokens = encoder.encode(filesInput).length;
            const outputTokens = encoder.encode(scnOutput).length;
            setTokenCounts({ input: inputTokens, output: outputTokens });
          } catch (e) {
            console.error("Tokenization error:", e);
            setTokenCounts({ input: 0, output: 0 });
          }
        }, [filesInput, scnOutput, encoder]);

        return tokenCounts;
      }
    patchStrategy: replace
snapshot:
  packages/scn-ts-web-demo/src/hooks/useResizableSidebar.hook.ts: null
  packages/scn-ts-web-demo/src/hooks/useClipboard.hook.ts: null
  packages/scn-ts-web-demo/src/hooks/useAnalysis.hook.ts: null
  packages/scn-ts-web-demo/src/hooks/useTokenCounter.hook.ts: null
approved: true
